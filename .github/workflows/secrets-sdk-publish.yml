
name: Secrets SDK Publish
"on":
  workflow_dispatch:

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/secrets
    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@8ca2b8b2ece13480cda6dacd3511b49857a23c09 # v2.5.1
      with:
        egress-policy: audit

    - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3.6.0
    - name: Setup node
      uses: actions/setup-node@5e21ff4d9bc1a8cf6de233a3057d20ec6b3fb69d # v3.8.1
      with:
        node-version: 16
        check-latest: true
        cache: npm
    - name: Install dependencies
      run: npm ci --ignore-scripts
    - name: Build source
      run: npm run build:ts
    - name: Publish
      run: |
        sed -i "s/\"private\": true/\"private\": false/" package.json
        npx -y npm-cli-login
        npm publish --access public
        npm dist-tag add @zowe/secrets-for-zowe-sdk@$(cat package.json | jq -r .version) zowe-v2-lts
        npm dist-tag add @zowe/secrets-for-zowe-sdk@$(cat package.json | jq -r .version) next
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NPM_USER: ${{ secrets.ARTIFACTORY_USERNAME }}
        NPM_PASS: ${{ secrets.ARTIFACTORY_PASSWORD }}
        NPM_EMAIL: ${{ secrets.ZOWE_ROBOT_EMAIL }}
        NPM_REGISTRY: "https://zowe.jfrog.io/zowe/api/npm/npm-local-release"
        NPM_SCOPE: "@zowe"
        SECRETS_BRANCH: ${{ github.ref_name }}
